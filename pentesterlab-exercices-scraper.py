import requests
import datetime
from bs4 import BeautifulSoup
import csv

class Scraper:

    def __init__(self):
        self.domain_url = 'https://pentesterlab.com'
        self.exercices_slug = '/exercises/'
        self.exercice_landing_slug = '/course/'
        self.exercices_url = self.domain_url + self.exercices_slug
        self.exercises_list = []

    def scrape(self):
        exercices_bs = BeautifulSoup(requests.get(self.exercices_url).text, 'html.parser').body.section.table.tbody.find_all('tr', class_='row-show')
        label_remove = -len(' label')
        href_remove = len(self.exercices_slug)
        for row in exercices_bs:
            exercice = {}
            data_list = row['data-member'].split()
            exercice['access'] = data_list[0]
            exercice['difficulty'] = data_list[1]
            if len(data_list) > 2 and data_list[2] == 'cve':
                exercice['cve'] = 1
                vulnerabilities_first_index = 3
            else:
                exercice['cve'] = 0
                vulnerabilities_first_index = 2

            # if len(data_list) > 3 and data_list[2] != 'cve':
            #     print(data_list)
            # ['free', 'medium', 'sqli', 'xss'] multitags = 1 / 475 !!

            exercice['tags'] = ' '.join(data_list[vulnerabilities_first_index:])

            exercice['icon'] = row.th.img['alt'][:label_remove].replace(' ','_')
            exercice['title'] = row.td.a.text
            exercice['url'] = self.domain_url + row.td.a['href'] + self.exercice_landing_slug
            exercice['slug'] = row.td.a['href'][href_remove:]
            
            td_list = row.find_all('td')
            exercice['duration'] = td_list[1].text
            exercice['completions'] = td_list[3].text
        
            self.exercises_list.append(exercice)
        
        return len(self.exercises_list)

    def export_to_csv(self, dialect='unix'): 
        # https://www.pythontutorial.net/python-basics/python-write-csv-file/
        filename = 'pentesterlab-exercices-' + datetime.datetime.now().strftime('%Y%m%d-%H%M%S')+'.csv'
        with open(filename, 'w', encoding='UTF8', newline='') as file:
            writer = csv.DictWriter(file, fieldnames = self.exercises_list[0].keys(), dialect=dialect)
            writer.writeheader()
            writer.writerows(self.exercises_list)

if __name__ == "__main__":
    scraper = Scraper()
    print(f'{scraper.scrape()} Exercices Scraped')
    scraper.export_to_csv()
